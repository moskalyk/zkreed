{"ast":null,"code":"\"use strict\";\n/*\n * Copyright 2021 Fluence Labs Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nvar __read = this && this.__read || function (o, n) {\n  var m = typeof Symbol === \"function\" && o[Symbol.iterator];\n  if (!m) return o;\n  var i = m.call(o),\n      r,\n      ar = [],\n      e;\n\n  try {\n    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\n  } catch (error) {\n    e = {\n      error: error\n    };\n  } finally {\n    try {\n      if (r && !r.done && (m = i[\"return\"])) m.call(i);\n    } finally {\n      if (e) throw e.error;\n    }\n  }\n\n  return ar;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.marineLogLevelToEnvs = exports.throwIfNotSupported = exports.jsonify = exports.dataToString = exports.checkConnection = exports.doNothing = exports.handleTimeout = exports.MakeServiceCall = void 0;\n\nvar loglevel_1 = __importDefault(require(\"loglevel\"));\n\nvar platform_1 = __importDefault(require(\"platform\"));\n\nvar commonTypes_1 = require(\"./commonTypes\");\n\nvar Buffer_1 = __importDefault(require(\"./Buffer\"));\n\nvar MakeServiceCall = function (fn) {\n  return function (req) {\n    return {\n      retCode: commonTypes_1.ResultCodes.success,\n      result: fn(req.args)\n    };\n  };\n};\n\nexports.MakeServiceCall = MakeServiceCall;\n\nvar handleTimeout = function (fn) {\n  return function (stage) {\n    if (stage.stage === 'expired') {\n      fn();\n    }\n  };\n};\n\nexports.handleTimeout = handleTimeout;\n\nvar doNothing = function () {\n  var _args = [];\n\n  for (var _i = 0; _i < arguments.length; _i++) {\n    _args[_i] = arguments[_i];\n  }\n\n  return undefined;\n};\n\nexports.doNothing = doNothing;\n/**\n * Checks the network connection by sending a ping-like request to relay node\n * @param { FluenceClient } peer - The Fluence Client instance.\n */\n\nvar checkConnection = function (peer, ttl) {\n  return __awaiter(void 0, void 0, void 0, function () {\n    var msg, promise, result, e_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          if (!peer.getStatus().isConnected) {\n            return [2\n            /*return*/\n            , false];\n          }\n\n          msg = Math.random().toString(36).substring(7);\n          promise = new Promise(function (resolve, reject) {\n            var script = \"\\n    (xor\\n        (seq\\n            (call %init_peer_id% (\\\"load\\\" \\\"relay\\\") [] init_relay)\\n            (seq\\n                (call %init_peer_id% (\\\"load\\\" \\\"msg\\\") [] msg)\\n                (seq \\n                    (call init_relay (\\\"op\\\" \\\"identity\\\") [msg] result)\\n                    (call %init_peer_id% (\\\"callback\\\" \\\"callback\\\") [result])\\n                )\\n            )\\n        )\\n        (seq \\n            (call init_relay (\\\"op\\\" \\\"identity\\\") [])\\n            (call %init_peer_id% (\\\"callback\\\" \\\"error\\\") [%last_error%])\\n        )\\n    )\";\n            var particle = peer.internals.createNewParticle(script, ttl);\n\n            if (particle instanceof Error) {\n              return reject(particle.message);\n            }\n\n            peer.internals.regHandler.forParticle(particle.id, 'load', 'relay', (0, exports.MakeServiceCall)(function () {\n              return peer.getStatus().relayPeerId;\n            }));\n            peer.internals.regHandler.forParticle(particle.id, 'load', 'msg', (0, exports.MakeServiceCall)(function () {\n              return msg;\n            }));\n            peer.internals.regHandler.forParticle(particle.id, 'callback', 'callback', (0, exports.MakeServiceCall)(function (args) {\n              var _a = __read(args, 1),\n                  val = _a[0];\n\n              setTimeout(function () {\n                resolve(val);\n              }, 0);\n              return {};\n            }));\n            peer.internals.regHandler.forParticle(particle.id, 'callback', 'error', (0, exports.MakeServiceCall)(function (args) {\n              var _a = __read(args, 1),\n                  error = _a[0];\n\n              setTimeout(function () {\n                reject(error);\n              }, 0);\n              return {};\n            }));\n            peer.internals.initiateParticle(particle, (0, exports.handleTimeout)(function () {\n              reject('particle timed out');\n            }));\n          });\n          _a.label = 1;\n\n        case 1:\n          _a.trys.push([1, 3,, 4]);\n\n          return [4\n          /*yield*/\n          , promise];\n\n        case 2:\n          result = _a.sent();\n\n          if (result != msg) {\n            loglevel_1.default.warn(\"unexpected behavior. 'identity' must return the passed arguments.\");\n          }\n\n          return [2\n          /*return*/\n          , true];\n\n        case 3:\n          e_1 = _a.sent();\n          loglevel_1.default.error('Error on establishing connection: ', e_1);\n          return [2\n          /*return*/\n          , false];\n\n        case 4:\n          return [2\n          /*return*/\n          ];\n      }\n    });\n  });\n};\n\nexports.checkConnection = checkConnection;\n\nfunction dataToString(data) {\n  var text = new TextDecoder().decode(Buffer_1.default.from(data)); // try to treat data as json and pretty-print it\n\n  try {\n    return JSON.stringify(JSON.parse(text), null, 4);\n  } catch (_a) {\n    return text;\n  }\n}\n\nexports.dataToString = dataToString;\n\nfunction jsonify(obj) {\n  return JSON.stringify(obj, null, 4);\n}\n\nexports.jsonify = jsonify;\n\nfunction throwIfNotSupported() {\n  if (platform_1.default.name === 'Node.js' && platform_1.default.version) {\n    var version = platform_1.default.version.split('.').map(Number);\n    var major = version[0];\n\n    if (major < 16) {\n      throw new Error('FluenceJS requires node.js version >= \"16.x\"; Detected ' + platform_1.default.description + ' Please update node.js to version 16 or higher.\\nYou can use https://nvm.sh utility to update node.js version: \"nvm install 17 && nvm use 17 && nvm alias default 17\"');\n    }\n  }\n}\n\nexports.throwIfNotSupported = throwIfNotSupported;\n\nvar marineLogLevelToEnvs = function (marineLogLevel) {\n  return marineLogLevel ? {\n    WASM_LOG: marineLogLevel\n  } : undefined;\n};\n\nexports.marineLogLevelToEnvs = marineLogLevelToEnvs;","map":{"version":3,"mappings":"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","names":["MakeServiceCall","fn","req","retCode","commonTypes_1","success","result","args","exports","handleTimeout","stage","doNothing","_args","checkConnection","peer","ttl","getStatus","isConnected","msg","Math","random","toString","substring","promise","Promise","resolve","reject","script","particle","internals","createNewParticle","Error","message","regHandler","forParticle","id","relayPeerId","val","setTimeout","error","initiateParticle","_a","loglevel_1","warn","e_1","dataToString","data","text","TextDecoder","decode","Buffer_1","from","JSON","stringify","parse","jsonify","obj","throwIfNotSupported","platform_1","name","version","split","map","Number","major","description","marineLogLevelToEnvs","marineLogLevel","WASM_LOG","undefined"],"sources":["/Users/mgrok/Projects/fluence-projects/examples/quickstart/1-browser-to-browser/node_modules/@fluencelabs/fluence/src/internal/utils.ts"],"sourcesContent":["/*\n * Copyright 2021 Fluence Labs Limited\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport log from 'loglevel';\nimport platform from 'platform';\n\nimport { CallServiceData, CallServiceResult, CallServiceResultType, ResultCodes } from './commonTypes';\nimport { FluencePeer } from './FluencePeer';\nimport { LogLevel } from '@fluencelabs/avm';\nimport { ParticleExecutionStage } from './Particle';\nimport Buffer from './Buffer';\n\nexport const MakeServiceCall =\n    (fn: (args: any[]) => CallServiceResultType) =>\n    (req: CallServiceData): CallServiceResult => ({\n        retCode: ResultCodes.success,\n        result: fn(req.args),\n    });\n\nexport const handleTimeout = (fn: () => void) => (stage: ParticleExecutionStage) => {\n    if (stage.stage === 'expired') {\n        fn();\n    }\n};\nexport const doNothing = (..._args: Array<unknown>) => undefined;\n\n/**\n * Checks the network connection by sending a ping-like request to relay node\n * @param { FluenceClient } peer - The Fluence Client instance.\n */\nexport const checkConnection = async (peer: FluencePeer, ttl?: number): Promise<boolean> => {\n    if (!peer.getStatus().isConnected) {\n        return false;\n    }\n\n    const msg = Math.random().toString(36).substring(7);\n\n    const promise = new Promise<string>((resolve, reject) => {\n        const script = `\n    (xor\n        (seq\n            (call %init_peer_id% (\"load\" \"relay\") [] init_relay)\n            (seq\n                (call %init_peer_id% (\"load\" \"msg\") [] msg)\n                (seq \n                    (call init_relay (\"op\" \"identity\") [msg] result)\n                    (call %init_peer_id% (\"callback\" \"callback\") [result])\n                )\n            )\n        )\n        (seq \n            (call init_relay (\"op\" \"identity\") [])\n            (call %init_peer_id% (\"callback\" \"error\") [%last_error%])\n        )\n    )`;\n        const particle = peer.internals.createNewParticle(script, ttl);\n\n        if (particle instanceof Error) {\n            return reject(particle.message);\n        }\n\n        peer.internals.regHandler.forParticle(\n            particle.id,\n            'load',\n            'relay',\n            MakeServiceCall(() => {\n                return peer.getStatus().relayPeerId;\n            }),\n        );\n\n        peer.internals.regHandler.forParticle(\n            particle.id,\n            'load',\n            'msg',\n            MakeServiceCall(() => {\n                return msg;\n            }),\n        );\n\n        peer.internals.regHandler.forParticle(\n            particle.id,\n            'callback',\n            'callback',\n            MakeServiceCall((args) => {\n                const [val] = args;\n                setTimeout(() => {\n                    resolve(val);\n                }, 0);\n                return {};\n            }),\n        );\n\n        peer.internals.regHandler.forParticle(\n            particle.id,\n            'callback',\n            'error',\n            MakeServiceCall((args) => {\n                const [error] = args;\n                setTimeout(() => {\n                    reject(error);\n                }, 0);\n                return {};\n            }),\n        );\n\n        peer.internals.initiateParticle(\n            particle,\n            handleTimeout(() => {\n                reject('particle timed out');\n            }),\n        );\n    });\n\n    try {\n        const result = await promise;\n        if (result != msg) {\n            log.warn(\"unexpected behavior. 'identity' must return the passed arguments.\");\n        }\n        return true;\n    } catch (e) {\n        log.error('Error on establishing connection: ', e);\n        return false;\n    }\n};\n\nexport function dataToString(data: Uint8Array) {\n    const text = new TextDecoder().decode(Buffer.from(data));\n    // try to treat data as json and pretty-print it\n    try {\n        return JSON.stringify(JSON.parse(text), null, 4);\n    } catch {\n        return text;\n    }\n}\n\nexport function jsonify(obj: unknown) {\n    return JSON.stringify(obj, null, 4);\n}\n\nexport function throwIfNotSupported() {\n    if (platform.name === 'Node.js' && platform.version) {\n        const version = platform.version.split('.').map(Number);\n        const major = version[0];\n        if (major < 16) {\n            throw new Error(\n                'FluenceJS requires node.js version >= \"16.x\"; Detected ' +\n                    platform.description +\n                    ' Please update node.js to version 16 or higher.\\nYou can use https://nvm.sh utility to update node.js version: \"nvm install 17 && nvm use 17 && nvm alias default 17\"',\n            );\n        }\n    }\n}\n\n/**\n * Enum representing the log level used in Aqua VM.\n * Possible values: 'info', 'trace', 'debug', 'info', 'warn', 'error', 'off';\n */\nexport type MarineLoglevel = LogLevel;\n\nexport const marineLogLevelToEnvs = (marineLogLevel: MarineLoglevel | undefined) =>\n    marineLogLevel ? { WASM_LOG: marineLogLevel } : undefined;\n"]},"metadata":{},"sourceType":"script"}